#!/bin/bash                                                                                                                                     
#SBATCH --account=dessn
#SBATCH --time=24:00:00
#SBATCH --qos=shared
#SBATCH --nodes=1
#SBATCH --constraint=cpu
#SBATCH --cpus-per-task=32
#SBATCH --output=test_step1step2-%j.out


export STACKCVMFS=/cvmfs/sw.lsst.eu/linux-x86_64/lsst_distrib
export LSST_STACK_VERSION=v27.0.0

module load cpu

source $STACKCVMFS/$LSST_STACK_VERSION/loadLSST-ext.bash
setup lsst_distrib

export OMP_NUM_THREADS=1


# make the custom coadd QuantumGraph visualization
pipetask build \
-p $DRP_PIPE_DIR/pipelines/LSSTCam-imSim/DRP-test-med-1.yaml#step1,step2 \
--pipeline-dot pipeline.dot; \
dot pipeline.dot -Tpdf > step1step2.pdf

# remove temporary file
rm pipeline.dot 

# specify the directory for output log files
LOGDIR=logs

# make the directory for output log files
mkdir $LOGDIR

# run the custom coaddition
LOGFILE=$LOGDIR/step1step2-logfile.log; \
date | tee $LOGFILE; \
pipetask --long-log --log-file $LOGFILE run \
-b /global/cfs/cdirs/lsst/production/gen3/DC2/Run2.2i/repo \
-i LSSTCam-imSim/defaults \
-o u/taceroc_pm/test_512025_1_t4026p15y2022 \
-p $DRP_PIPE_DIR/pipelines/LSSTCam-imSim/DRP-test-med-1.yaml#step1,step2 \
-d "tract=4026 AND patch=15 AND day_obs in (20220103,20220108,20220111,20220117,20220219,20220730,20220806,20220811,20220813,20220818,20220827,20220829,20220831,20220909,20220912,20220914,20220916,20220917,20220928,20221001,20221004,20221006,20221008,20221009,20221013,20221014,20221015,20221016,20221017,20221024,20221026,20221103,20221114,20221122,20221128,20221201,20221202,20221215,20221218,20221221,20221223) AND skymap='DC2'"; \
date | tee -a $LOGFILE

# "tract = 3838 AND patch = 36 AND skymap = 'DC2'"; \


# 2022 (20220103,20220108,20220111,20220117,20220219,20220730,20220806,20220811,20220813,20220818,20220827,20220829,20220831,20220909,20220912,20220914,20220916,20220917,20220928,20221001,20221004,20221006,20221008,20221009,20221013,20221014,20221015,20221016,20221017,20221024,20221026,20221103,20221114,20221122,20221128,20221201,20221202,20221215,20221218,20221221,20221223)
# 2023 (20230101,20230105,20230112,20230113,20230123,20230130,20230202,20230301,20230305,20230716,20230717,20230719,20230721,20230802,20230805,20230809,20230820,20230822,20230823,20230827,20230830,20230910,20230912,20230913,20230923,20230927,20230929,20231006,20231016,20231022,20231023,20231024,20231029,20231111,20231120,20231129,20231130,20231201,20231207,20231230)
# 2024 (20240225,20240228,20240320,20240710,20240805,20240807,20240808,20240811,20240818,20240823,20240826,20240827,20240903,20240905,20240914,20240915,20240920,20240929,20240930,20241001,20241002,20241007,20241013,20241017,20241019,20241020,20241021,20241022,20241026,20241027,20241029,20241110,20241111,20241112,20241113,20241115,20241116,20241117,20241202,20241203,20241211,20241216,20241219)
# 2025 (20250110,20250111,20250120,20250223,20250305,20250314,20250713,20250714,20250806,20250809,20250810,20250811,20250817,20250819,20250822,20250823,20250915,20250918,20250919,20250923,20250924,20250925,20251003,20251005,20251006,20251008,20251011,20251012,20251015,20251022,20251024,20251027,20251031,20251111,20251113,20251115,20251116,20251118,20251123,20251127,20251129,20251205,20251207,20251218,20251222)
# 2026 (20260101,20260102,20260103,20260104,20260118,20260125,20260130,20260201,20260204,20260208,20260212,20260221,20260228,20260301,20260302,20260307,20260309,20260320,20260729,20260801,20260806,20260816,20260819,20260824,20260825,20260826,20260902,20260913,20260915,20260919,20260922,20260924,20260925,20260927,20261001,20261004,20261006,20261007,20261008,20261011,20261013,20261014,20261015,20261017,20261018,20261020,20261022,20261023,20261026,20261111,20261113,20261115,20261118,20261119,20261121,20261124,20261126,20261128,20261130,20261204,20261212,20261216,20261217,20261219)